<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{fragments/default_layout}">
	<div layout:fragment="content">	
	  <!-- Page Heading -->
	  <div class="d-sm-flex align-items-center justify-content-between mb-4">
	      <h1 class="h3 mb-0 text-gray-800">소방 점검</h1>
	  </div>
		<!-- Datas -->
		<input type="text" id="facility_check_id" th:value="${facility_check_id}" style="display:none;"/>
		<input type="text" id="isAdd" th:value="${#sets.isEmpty(facilityCheck)?true:false}" style="display:none;"/>
		<input type="text" id="selected_check_date" th:value="${#sets.isEmpty(facilityCheck)? '' : #temporals.format(facilityCheck.checkDate, 'yyyy-MM-dd')}" style="display:none;"/>

		<!-- Content Row -->
		<div class="row">
			<div class="col-lg-6 col-xl-6 col-md-6 mb-6">
				<div class="align-items-center justify-content-between mb-4">
					<div class="col mr-2">
						<nav class="navbar navbar-expand navbar-light bg-light mb-4">
							<a class="navbar-brand" href="#">호선</a>
							<ul class="navbar-nav ml-auto">
								<li class="nav-item dropdown">
									<a class="nav-link dropdown-toggle station-parent-bar" href="#" th:text="${#sets.isEmpty(facilityCheck)? '선택' : facilityCheck.lineName}" th:data-value="${#sets.isEmpty(facilityCheck)? '' : facilityCheck.lineId}"
									   id="line-parent"  value="" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										선택
									</a>
									<div class="dropdown-menu dropdown-menu-right animated--grow-in" id="line-child-group" aria-labelledby="navbarDropdown">

									</div>
								</li>
							</ul>
						</nav>
					</div>
				</div>
			</div>
			<div class="col-lg-6 col-xl-6 col-md-6 mb-6">
				<div class="align-items-center justify-content-between mb-4">
					<div class="col mr-2">
						<nav class="navbar navbar-expand navbar-light bg-light mb-4">
							<a class="navbar-brand" href="#">역 명</a>
							<ul class="navbar-nav ml-auto">
								<li class="nav-item dropdown">
									<a class="nav-link dropdown-toggle" href="#" th:text="${#sets.isEmpty(facilityCheck)? '선택' : facilityCheck.stationName}" th:data-value="${#sets.isEmpty(facilityCheck)? '' : facilityCheck.stationId}" id="station-parent" readonly="true" value="" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										선택
									</a>
									<div class="dropdown-menu dropdown-menu-right animated--grow-in" id="station-child-group" aria-labelledby="navbarDropdown">
										<a class="dropdown-item" href="#">호선부터 선택해주세요</a>
									</div>
								</li>
							</ul>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<!-- Content Row -->
		<div class="row">
			<div class="col-lg-6 col-xl-6 col-md-6 mb-6">
				<div class="align-items-center justify-content-between mb-4">
					<div class="col mr-2">
						<nav class="navbar navbar-expand navbar-light bg-light mb-4">
							<a class="navbar-brand" href="#">매장 명</a>
							<ul class="navbar-nav ml-auto">
								<li class="nav-item dropdown">
									<a class="nav-link dropdown-toggle" href="#" th:text="${#sets.isEmpty(facilityCheck)? '선택' : facilityCheck.shopName}" th:data-value="${#sets.isEmpty(facilityCheck)? '' : facilityCheck.shopId}" id="shop-parent" role="button" value="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										선택
									</a>
									<div class="dropdown-menu dropdown-menu-right animated--grow-in" id="shop-child-group" aria-labelledby="navbarDropdown">
										<a class="dropdown-item" href="#">역부터 선택해주세요</a>
									</div>
								</li>
							</ul>
						</nav>
					</div>
				</div>
			</div>
			<div class="col-lg-6 col-xl-6 col-md-6 mb-6">
				<div class="align-items-center justify-content-between mb-4">
					<div class="col mr-2">
						<nav class="navbar navbar-expand navbar-light bg-light mb-4">
							<a class="navbar-brand" href="#">날짜</a>
							<div class="navbar-nav ml-auto">
								<div class="nav-item dropdown">

									<div class="datepicker">
										<input type="text" class="selected-check-date" id="datepicker-input">
									</div>
								</div>
							</div>
						</nav>

					</div>
				</div>
			</div>
		</div>
		<div id="check-list" style="display:none;">
			<!-- Content Row -->
			<div class="row">
				<div class="col-lg-12 mb-4">
					<div class="card bg-info text-white shadow">
						<div class="card-body">
							소화기
						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row">
				<div class="col-lg-8 col-xl-8 col-md-8 mb-8">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-2">
							<div class="text-black-50">
								1. 소화기 종류
							</div>

						</div>
					</div>
				</div>
				<div class="col-lg-4 col-xl-4 col-md-4 mb-4">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-3">
							<div class="custom-select-radio">
								<input class="custom-radio" id="fireExtinguisher_type_haron" type="radio" name="fireExtinguisher_type" value="0"/>
								<label class="form-check-label" for="fireExtinguisher_type_haron">
									하론 3L
								</label>
								<input class="custom-radio" id="fireExtinguisher_type_powder" type="radio" name="fireExtinguisher_type" value="1" />
								<label class="form-check-label" for="fireExtinguisher_type_powder">
									분말 3.3KG
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-8 col-xl-8 col-md-8 mb-8">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-2">
							<div class="text-black-50">
								2. 소화기 개수
							</div>

						</div>
					</div>
				</div>
				<div class="col-lg-4 col-xl-4 col-md-4 mb-4">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-3">
							<div class="custom-select-radio">
								<input id="fireExtinguisher_count" type="number" value="0" />
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row">
				<div class="col-lg-12 mb-4">
					<div class="card bg-info text-white shadow">
						<div class="card-body">
							전기
						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row" th:each="inspection, index : ${inspection_electricity}">
				<div class="col-lg-8 col-xl-8 col-md-8 mb-8">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-2">
							<div class="text-black-50" th:text="${index.count}+'. '+${inspection.detail}">
								1. 집기의 전기안전관리 상태는 양호한가? (차단기/SMPS/과부화등)
							</div>

						</div>
					</div>
				</div>
				<div class="col-lg-4 col-xl-4 col-md-4 mb-4">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-3">
							<div class="custom-select-radio">
								<input class="custom-radio" th:id="${inspection.inspectId}+'no'" type="radio" onClick="sendInspectionRespond(this.getAttribute('name'),this.value)" th:name="${inspection.inspectId}" value="0" />
								<label class="form-check-label" th:for="${inspection.inspectId}+'no'">
									아니오
								</label>
								<input class="custom-radio" th:id="${inspection.inspectId}+'yes'" type="radio" onClick="sendInspectionRespond(this.getAttribute('name'),this.value)" th:name="${inspection.inspectId}" value="1" />
								<label class="form-check-label" th:for="${inspection.inspectId}+'yes'">
									예
								</label>
								<input class="custom-radio" th:id="${inspection.inspectId}+'none'" type="radio" onClick="sendInspectionRespond(this.getAttribute('name'),this.value)" th:name="${inspection.inspectId}" value="2" />
								<label class="form-check-label" th:for="${inspection.inspectId}+'none'">
									미적용
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row">
				<div class="col-lg-12 mb-4">
					<div class="card bg-info text-white shadow">
						<div class="card-body">
							소방
						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row" th:each="inspection, index : ${inspection_firefighting}">
				<div class="col-lg-8 col-xl-8 col-md-8 mb-8">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-2">
							<div class="text-black-50" th:text="${index.count}+'. '+${inspection.detail}">
								1. 집기의 전기안전관리 상태는 양호한가? (차단기/SMPS/과부화등)
							</div>

						</div>
					</div>
				</div>
				<div class="col-lg-4 col-xl-4 col-md-4 mb-4">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-3">
							<div class="custom-select-radio">
								<input class="custom-radio" th:id="${inspection.inspectId}+'no'" type="radio" onClick="sendInspectionRespond(this.getAttribute('name'),this.value)" th:name="${inspection.inspectId}" value="0" />
								<label class="form-check-label" th:for="${inspection.inspectId}+'no'">
									아니오
								</label>
								<input class="custom-radio" th:id="${inspection.inspectId}+'yes'" type="radio" onClick="sendInspectionRespond(this.getAttribute('name'),this.value)" th:name="${inspection.inspectId}" value="1" />
								<label class="form-check-label" th:for="${inspection.inspectId}+'yes'">
									예
								</label>
								<input class="custom-radio" th:id="${inspection.inspectId}+'none'" type="radio" onClick="sendInspectionRespond(this.getAttribute('name'),this.value)" th:name="${inspection.inspectId}" value="2" />
								<label class="form-check-label" th:for="${inspection.inspectId}+'none'">
									미적용
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row">
				<div class="col-lg-12 mb-4">
					<div class="card bg-info text-white shadow">
						<div class="card-body">
							위험요소
						</div>
					</div>
				</div>
			</div>

			<!-- Content Row -->
			<div class="row" th:each="inspection, index : ${inspection_danger}">
				<div class="col-lg-8 col-xl-8 col-md-8 mb-8">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-2">
							<div class="text-black-50" th:text="${index.count}+'. '+${inspection.detail}">
								1. 집기의 전기안전관리 상태는 양호한가? (차단기/SMPS/과부화등)
							</div>

						</div>
					</div>
				</div>
				<div class="col-lg-4 col-xl-4 col-md-4 mb-4">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-3">
							<div class="custom-select-radio">
								<input class="custom-radio" th:id="${inspection.inspectId}+'no'" type="radio" onClick="sendInspectionRespond(this.getAttribute('name'),this.value)" th:name="${inspection.inspectId}" value="0" />
								<label class="form-check-label" th:for="${inspection.inspectId}+'no'">
									아니오
								</label>
								<input class="custom-radio" th:id="${inspection.inspectId}+'yes'" type="radio" onClick="sendInspectionRespond(this.getAttribute('name'),this.value)" th:name="${inspection.inspectId}" value="1" />
								<label class="form-check-label" th:for="${inspection.inspectId}+'yes'">
									예
								</label>
								<input class="custom-radio" th:id="${inspection.inspectId}+'none'" type="radio" onClick="sendInspectionRespond(this.getAttribute('name'),this.value)" th:name="${inspection.inspectId}" value="2" />
								<label class="form-check-label" th:for="${inspection.inspectId}+'none'">
									미적용
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row">
				<div class="col-lg-12 mb-4">
					<div class="card bg-info text-white shadow">
						<div class="card-body">
							기타
						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row">
				<div class="col-lg-12 col-xl-12 col-md-12 mb-12">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-2">
							<textarea class="form-control" id="extra_memo" rows="10" style="width:100%;resize:none;" placeholder="내용을 입력해 주세요."></textarea>

						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row">
				<div class="col-lg-12 col-xl-12 col-md-12 mb-12">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-2">
							<h5 class="h5 text-gray-800">파일 첨부
							</h5>
							<!-- We'll transform this input into a pond -->
							<input type="file" class="filepond" />
						</div>
					</div>
				</div>
			</div>
			<!-- Content Row -->
			<div class="row">
				<div class="col-lg-6 col-xl-6 col-md-6 mb-6">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-2">
						</div>
					</div>
				</div>
				<div class="col-lg-6 col-xl-6 col-md-6 mb-6">
					<div class="align-items-center justify-content-between mb-4">
						<div class="col mr-2">

							<a onClick="sendFacilityCheck()" class="d-none d-sm-inline-block btn btn-sm btn-success shadow-sm" style="display: block !important;"><i
									class="fas fa-save fa-sm text-white-50"></i>&nbsp완료</a>
						</div>
					</div>
				</div>

			</div>
		</div>
	<script class="code-js">
		document.addEventListener("DOMContentLoaded", function() {
			var selectedDate = new Date();
			if(document.getElementById("selected_check_date").value){
				selectedDate =  new Date(document.getElementById("selected_check_date").value);
			}
			flatpickr(document.getElementById("datepicker-input"),{
				dateFormat: "Y-m-d",
				defaultDate: selectedDate,
				onChange: function(selectedDates, dateStr, instance){
					dateChangeEvent();
				}
			});
			/*[GET] station line list*/
			const request = new XMLHttpRequest();
			request.open('get', '/code/all_line');
			request.onload = function () {
				if (request.status >= 200 && request.status < 300) {
					// the load method accepts either a string (id) or an object
					var response = JSON.parse(request.response);
					var code = response.status;
					var childGroup = document.getElementById("line-child-group");
					childGroup.innerHTML = "";
					//<a class="dropdown-item line-child" href="#">Action</a>
					response.data.forEach(function (e) {
						console.log(e);
						var newChild = document.createElement("a");
						newChild.classList.add("dropdown-item");
						newChild.classList.add("line-child");
						newChild.href="#";
						newChild.setAttribute("data-value",e.id)
						newChild.innerText=e.name;
						newChild.onclick = function(){
							var lineParent = document.getElementById("line-parent");
							lineParent.setAttribute("data-value",this.getAttribute("data-value"));
							lineParent.innerHTML = this.innerHTML;
							getStationList(this.getAttribute("data-value"));

							document.getElementById("station-parent").removeAttribute("data-value");
							document.getElementById("station-parent").innerHTML = "선택";
							document.getElementById("shop-parent").removeAttribute("data-value");
							document.getElementById("shop-parent").innerHTML = "선택";
							document.getElementById("check-list").style.display="none";
						}
						childGroup.append(newChild);
					})

				} else {
					alert("정상수신실패:"+request.status);
				}

			}
			request.send();

			/*EDIT PAGE setting*/
			var lineParent = document.getElementById("line-parent");
			var lineParentText = lineParent.innerText;
			var lineParentValue= lineParent.getAttribute("data-value");
			var stationParent = document.getElementById("station-parent");
			var stationParentText = stationParent.innerText;
			var stationParentValue= stationParent.getAttribute("data-value");
			var shopParent = document.getElementById("shop-parent");
			var shopParentText = shopParent.innerText;
			var shopParentValue= shopParent.getAttribute("data-value");
			if(lineParentValue){
				getStationList(lineParentValue);
				stationParent.innerText = stationParentText;
				stationParent.setAttribute("data-value",stationParentValue);
				if(stationParentValue){
					getShopList(stationParentValue);
					shopParent.innerText = shopParentText;
					shopParent.setAttribute("data-value",shopParentValue);

				}
			}

			/**
			 * ====================
			 *      File Pond
			 * ====================
			 */
			//File Uploader (Filepond.js) set option Start
			FilePond.setOptions({
				server: {
					process: (fieldName, file, metadata, load, error, progress, abort, transfer, options) => {
						// fieldName is the name of the input field
						// file is the actual file object to send
						const formData = new FormData();
						formData.append("document_id", document.getElementById("facility_check_id").value);
						formData.append("file", file);
						const request = new XMLHttpRequest();
						request.open('POST', '/file/upload');

						// Should call the progress method to update the progress to 100% before calling load
						// Setting computable to false switches the loading indicator to infinite mode
						request.upload.onprogress = (e) => {
							progress(e.lengthComputable, e.loaded, e.total);
						};

						// Should call the load method when done and pass the returned server file id
						// this server file id is then used later on when reverting or restoring a file
						// so your server knows which file to return without exposing that info to the client
						request.onload = function () {
							if (request.status >= 200 && request.status < 300) {
								// the load method accepts either a string (id) or an object
								var response = JSON.parse(request.response);
								var file_id = response.data;
								file.id = file_id;
								load(request.responseText);
							} else {
								// Can call the error method if something is wrong, should exit after
								error('oh no');
							}
						};

						request.send(formData);

						// Should expose an abort method so the request can be cancelled
						return {
							abort: () => {
								// This function is entered if the user has tapped the cancel button
								request.abort();

								// Let FilePond know the request has been cancelled
								abort();
							},
						};
					},remove: (processResult, load, error) => {
						// 'source' is the path of the file and should be sent to a server endpoint via http

						console.log(processResult);
						console.log(processResult.split('/')[3].trim())
						const formData = new FormData();
						formData.append("document_id", document.getElementById("facility_check_id").value);
						formData.append("file_id", processResult.split('/')[3].trim());
						const request = new XMLHttpRequest();
						request.open('POST', '/file/delete');
						// Should call the progress method to update the progress to 100% before calling load
						// Setting computable to false switches the loading indicator to infinite mode

						// Should call the load method when done and pass the returned server file id
						// this server file id is then used later on when reverting or restoring a file
						// so your server knows which file to return without exposing that info to the client
						request.onload = function () {
							if (request.status >= 200 && request.status < 300) {
								// the load method accepts either a string (id) or an object
								var response = JSON.parse(request.response);
								alert(response.data);
								console.log(response);

								load(request.responseText);
							} else {
								// Can call the error method if something is wrong, should exit after
								error('oh no');
							}
						};

						request.send(formData);

						// Should expose an abort method so the request can be cancelled
						return {
							abort: () => {
								// This function is entered if the user has tapped the cancel button
								request.abort();

								// Let FilePond know the request has been cancelled
								abort();
							},
						};
						// call the load method before ending the function
					}
				}
				// 파일 올리는 즉시 업로드 끄기
				, instantUpload: false
				, allowImageExifOrientation: true
				, allowImagePreview: true
				, acceptedFileTypes: [
					'image/*',
					'application/pdf',
					'application/x-zip-compressed',
					'text/plain',
					'application/msword',
					'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
					'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
					'application/vnd.ms-powerpoint',
				]
				, allowProcess: false
				, maxParallelUploads: 10 // 한번에 올릴 수 있는 파일 개수
				, maxFiles: 10
				, maxTotalFileSize: "200MB"
				, allowMultiple: true
				, allowRemove: true
			});

			var isAdd = document.getElementById("isAdd").value == 'true';
			if(!isAdd){
				updateRecentCheck()
			}
		});
		// Select the file input and use
		// create() to turn it into a pond
		// filepond js 만들기
		FilePond.registerPlugin(FilePondPluginImagePreview,FilePondPluginImageExifOrientation);
		var fileUploader = FilePond.create(document.querySelector('.filepond'));
		// 등록된 파일 불러오는곳
		document.addEventListener('FilePond:init', function () {
			const documentId = document.getElementById("facility_check_id").value;
			const request = new XMLHttpRequest();
			request.open('GET', '/file/selectDocumentFiles?documentId=' + documentId);

			// Should call the progress method to update the progress to 100% before calling load
			// Setting computable to false switches the loading indicator to infinite mode
			request.upload.onprogress = (e) => {
				progress(e.lengthComputable, e.loaded, e.total);
			};

			// Should call the load method when done and pass the returned server file id
			// this server file id is then used later on when reverting or restoring a file
			// so your server knows which file to return without exposing that info to the client


			request.onload = function () {
				if (request.status >= 200 && request.status < 300) {
					// the load method accepts either a string (id) or an object
					var response = JSON.parse(request.response);
					var code = response.status;
					var files = response.data;
					console.log(response);
					console.log(files.length);
					var file;
					for (var j = 0; j < files.length; j++) {
						console.log(files[j]);

						fileUploader.addFile("/file/filedownload/"+files[j].fileId);
						// 보여지는 파일 이름
						fileUploader.getFiles()[0].file.name = files[j].fileOriginalName;
						fileUploader.getFiles()[0].file.source = files[j].base64;
						// 이미 업로드 된 파일 재업로드 안되도록
						fileUploader.getFiles()[0].origin = 3;

						console.log(fileUploader.getFiles());
					}

				} else {
					// Can call the error method if something is wrong, should exit after
					alert( '저장된 파일을 불러오는데 실패하였습니다.');
				}
			};

			request.send();

		}, {once: true});

		function dateChangeEvent(){
			console.log("EVENT");
			if(document.getElementById("line-parent").getAttribute("data-value")){
				if(document.getElementById("station-parent").getAttribute("data-value")) {
					if (document.getElementById("shop-parent").getAttribute("data-value")) {
						const regex = new RegExp(/^\d{4}-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])$/);
						console.log(document.getElementById("datepicker-input").value);
						console.log(regex.test(document.getElementById("datepicker-input").value));
						if(regex.test(document.getElementById("datepicker-input").value))
							updateRecentCheck();
					}
				}
			}
		}

		function getStationList(lineId){
			/*[GET] station list*/
			const request = new XMLHttpRequest();
			request.open('get', '/code/stations_on_line?line_id='+lineId);
			request.onload = function () {
				if (request.status >= 200 && request.status < 300) {
					// the load method accepts either a string (id) or an object
					var response = JSON.parse(request.response);
					var childGroup = document.getElementById("station-child-group");

					childGroup.innerHTML = "";
 					//<a class="dropdown-item line-child" href="#">Action</a>
					response.data.forEach(function (e) {
						console.log(e);
						var newChild = document.createElement("a");
						newChild.classList.add("dropdown-item");
						newChild.classList.add("station-child");
						newChild.href="#";
						newChild.setAttribute("data-value",e.id)
						newChild.innerText=e.name;
						newChild.onclick = function(){
							var stationParent = document.getElementById("station-parent");
							stationParent.setAttribute("data-value",this.getAttribute("data-value"));
							stationParent.innerHTML = this.innerHTML;
							getShopList(this.getAttribute("data-value"));


							document.getElementById("shop-parent").removeAttribute("data-value");
							document.getElementById("shop-parent").innerHTML = "선택";
							document.getElementById("check-list").style.display="none";
						}
						childGroup.append(newChild);
					})

				} else {
					alert("정상수신실패:"+request.status);
				}

			}
			request.send();
		}
		function getShopList(stationId){
			/*[GET] station list*/
			const request = new XMLHttpRequest();
			request.open('get', '/code/shops_in_station?station_id='+stationId);
			request.onload = function () {
				if (request.status >= 200 && request.status < 300) {
					// the load method accepts either a string (id) or an object
					var response = JSON.parse(request.response);
					console.log(response);
					var childGroup = document.getElementById("shop-child-group");


					childGroup.innerHTML = "";
					//<a class="dropdown-item line-child" href="#">Action</a>
					response.data.forEach(function (e) {
						console.log(e);
						var newChild = document.createElement("a");
						newChild.classList.add("dropdown-item");
						newChild.classList.add("shop-child");
						newChild.href="#";
						newChild.setAttribute("data-value",e.id);
						newChild.innerText=e.name;
						newChild.onclick = function(){
							var shopParent = document.getElementById("shop-parent");
							shopParent.setAttribute("data-value",this.getAttribute("data-value"));
							shopParent.innerHTML = this.innerHTML;
							if(document.getElementById("datepicker-input").value){
								document.getElementById("check-list").style.display="block";
							}else{
								document.getElementById("check-list").style.display="none";
							}
							updateRecentCheck();
						}
						childGroup.append(newChild);
					})

				} else {
					alert("정상수신실패:"+request.status);
				}

			}
			request.send();
		}

		function sendInspectionRespond(id,selectedValue){
			var selectedDate = document.getElementById("datepicker-input");
			var facilityCheckId = document.getElementById("facility_check_id");
			var shopId = document.getElementById("shop-parent").getAttribute("data-value");
			var fireExtinguisherType = document.querySelector("input[name='fireExtinguisher_type']:checked").value;
			var fireExtinguisherCount = document.getElementById("fireExtinguisher_count").value;
			var memo = document.getElementById("extra_memo").value;
			console.log("date : "+ selectedDate.value)
			console.log("id : " + id);
			console.log("value : " + selectedValue);
			const formData = new FormData();
			formData.append("date", selectedDate.value);
			formData.append("inspect_id", id);
			formData.append("selectedValue", selectedValue);
			formData.append("check_id", facilityCheckId.value);
			formData.append("shopId", shopId);
			formData.append("fireExtinguisherType", fireExtinguisherType);
			formData.append("fireExtinguisherCount", fireExtinguisherCount);
			formData.append("memo", memo);

			/*[PUT] PUT DB single Inspection selection */
			const request = new XMLHttpRequest();
			request.open('post', '/works/facility_check/send_inspection');
			request.onload = function () {
				if (request.status >= 200 && request.status < 300) {
					// the load method accepts either a string (id) or an object
					var response = JSON.parse(request.response);
					console.log("저장됨");
					return true;
				} else {
					return false;
				}

			}
			request.send(formData);
		}
		function resetCheckList(){
			document.querySelectorAll("input[type=radio]").forEach(function(element){
				element.checked=false;
			})
			document.getElementById("fireExtinguisher_count").value = 0;
			document.getElementById("extra_memo").value = "";
			document.getElementById("check-list").style.display = "block";
		}
		function updateRecentCheck(){
			var shopId = document.getElementById("shop-parent").getAttribute("data-value");
			var selectedDate = document.getElementById("datepicker-input").value;
			resetCheckList();
			/*[GET] station list*/
			const request = new XMLHttpRequest();
			request.open('get', '/works/facility_check/facility_check_of_shop?shopId='+shopId+"&selectedDate="+selectedDate);
			request.onload = function () {
				if (request.status >= 200 && request.status < 300) {
					// the load method accepts either a string (id) or an object
					var response = JSON.parse(request.response);
					console.log(response);
					if(response.data){
						document.getElementById("fireExtinguisher_count").value = response.data.fireExtinguisherCount;
						document.getElementById("extra_memo").value = response.data.memo;
						document.getElementById("facility_check_id").value =  response.data.checkId;
						var extinguisherType = response.data.fireExtinguisherType;

						var	fireExtinguisherTypes = document.querySelectorAll("input[name='fireExtinguisher_type']");
						fireExtinguisherTypes.forEach(function(typeRadioInputs){
							if(parseInt(typeRadioInputs.value) === parseInt(extinguisherType)){
								typeRadioInputs.checked = true;
							}else{
								typeRadioInputs.checked = false;
							}
						});
						updateRecentInspection();
					}

					var code = response.status;

				} else {
					alert("정상수신실패:"+request.status);
				}

			}
			request.send();
		}

		function updateRecentInspection(){
			var checkId = document.getElementById("facility_check_id").value;
			/*[GET] station list*/
			const request = new XMLHttpRequest();
			request.open('get', '/works/facility_check/shop_inpections_on_date?checkId='+checkId);
			request.onload = function () {
				if (request.status >= 200 && request.status < 300) {
					// the load method accepts either a string (id) or an object
					var response = JSON.parse(request.response);
					console.log(response);
					response.data.forEach(function(inspection){
						document.querySelectorAll("input[name='"+inspection.inspectId+"']").forEach(function(typeRadioInputs){
							if(parseInt(typeRadioInputs.value) === parseInt(inspection.response)){
								typeRadioInputs.checked = true;
							}else{
								typeRadioInputs.checked = false;
							}
						});
					});

				} else {
					alert("정상수신실패:"+request.status);
				}

			}
			request.send();
		}

		function sendFacilityCheck(){
			fileUploader.processFiles().then(() => {
				var selectedDate = document.getElementById("datepicker-input");
				var facilityCheckId = document.getElementById("facility_check_id");
				var shopId = document.getElementById("shop-parent").getAttribute("data-value");
				var fireExtinguisherType = document.querySelector("input[name='fireExtinguisher_type']:checked").value;
				var fireExtinguisherCount = document.getElementById("fireExtinguisher_count").value;
				var memo = document.getElementById("extra_memo").value;
				console.log("date : "+ selectedDate.value)
				const formData = new FormData();
				formData.append("date", selectedDate.value);
				formData.append("check_id", facilityCheckId.value);
				formData.append("shopId", shopId);
				formData.append("fireExtinguisherType", fireExtinguisherType);
				formData.append("fireExtinguisherCount", fireExtinguisherCount);
				formData.append("memo", memo);

				/*[PUT] PUT DB single Inspection selection */
				const request = new XMLHttpRequest();
				request.open('post', '/works/facility_check/send_facility_check');
				request.onload = function () {

					if (request.status >= 200 && request.status < 300) {
						// the load method accepts either a string (id) or an object
						var response = JSON.parse(request.response);
						console.log(response);
						Swal.fire({
							position: "center",
							icon: "success",
							title: "저장 성공",
							showConfirmButton: false,
							timer: 1500
						}).then((result) => {
							if(result.dismiss === Swal.DismissReason.timer){
								location.href="/works/facility_check/facility_check_view?checkId="+facilityCheckId.value;
							}
						});
					} else {
						Swal.fire({
							position: "center",
							icon: "error",
							title: "저장 실패",
							showConfirmButton: false,
							timer: 1500
						}).then((result) => {
							if(result.dismiss === Swal.DismissReason.timer){
								location.reload();
							}
						});
					}

				}
				request.send(formData);
			});

		}
	</script>


	</div>
</html>